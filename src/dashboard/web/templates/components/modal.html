<div class="modal-backdrop" data-modal-backdrop>
  <article class="modal-card" data-modal-card role="dialog" aria-modal="true" aria-label="{{ widget_title }}">
    <header class="modal-header">
      <h2>{{ widget_title }}</h2>
      <button class="modal-close" type="button" data-close-modal>Close</button>
    </header>
    <div class="modal-body">
      {% if is_weather_widget %}
      {% if modal_weather_available %}
      <section class="modal-weather-summary">
        <div class="modal-weather-current">
          <p class="modal-weather-metric">{{ modal_weather_temp_display }}&deg;{{ modal_weather_unit_symbol }}</p>
          {% if modal_weather_condition %}
          <p class="modal-weather-condition">{{ modal_weather_condition }}</p>
          {% endif %}
          {% if modal_weather_location_label %}
          <p class="modal-weather-location">{{ modal_weather_location_label }}</p>
          {% endif %}
        </div>
        <dl class="modal-weather-meta-grid">
          <div>
            <dt>Provider</dt>
            <dd>{{ modal_weather_provider_label }}</dd>
          </div>
          <div>
            <dt>Coordinates</dt>
            <dd>{{ modal_weather_coordinates or "--" }}</dd>
          </div>
          <div>
            <dt>Last refresh</dt>
            <dd>{{ modal_weather_updated_at or "--" }}</dd>
          </div>
          <div>
            <dt>State</dt>
            <dd>{% if modal_weather_is_stale %}Stale{% else %}Fresh{% endif %}</dd>
          </div>
        </dl>
      </section>

      {% if modal_weather_daily %}
      <table class="modal-weather-table">
        <thead>
          <tr>
            <th scope="col">Day</th>
            <th scope="col">Condition</th>
            <th scope="col">High / Low</th>
            <th scope="col">Precip</th>
          </tr>
        </thead>
        <tbody>
          {% for day in modal_weather_daily %}
          <tr>
            <td>{{ day.day_label }}</td>
            <td>{{ day.condition }}</td>
            <td>{{ day.max_temp_display }}&deg; / {{ day.min_temp_display }}&deg;</td>
            <td>{{ day.precip_display }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
      {% else %}
      <p class="empty-state">No weather data cached yet.</p>
      {% endif %}
      {% elif is_calendar_widget %}
      {% if modal_calendar_available %}
      <dl class="modal-calendar-meta-grid">
        <div>
          <dt>Events</dt>
          <dd>{{ modal_calendar_event_count }}</dd>
        </div>
        <div>
          <dt>Sources</dt>
          <dd>{{ modal_calendar_source_count }}</dd>
        </div>
        <div>
          <dt>Last refresh</dt>
          <dd>{{ modal_calendar_updated_at or "--" }}</dd>
        </div>
        <div>
          <dt>State</dt>
          <dd>{% if modal_calendar_is_stale %}Stale{% else %}Fresh{% endif %}</dd>
        </div>
      </dl>
      {% if modal_calendar_target_date %}
      <p class="modal-meta">Date: {{ modal_calendar_target_date }}</p>
      {% endif %}

      <table class="modal-calendar-table">
        <thead>
          <tr>
            <th scope="col">Time</th>
            <th scope="col">Title</th>
            <th scope="col">Source</th>
            <th scope="col">Start</th>
            <th scope="col">End</th>
          </tr>
        </thead>
        <tbody>
          {% for event in modal_calendar_events %}
          <tr>
            <td>{{ event.time_label }}</td>
            <td>{{ event.display_title }}</td>
            <td>{{ event.source }}</td>
            <td>{{ event.start_display }}</td>
            <td>{{ event.end_display }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty-state">No calendar events cached yet for today.</p>
      {% endif %}
      {% if modal_calendar_error_messages %}
      <ul class="modal-calendar-errors">
        {% for message in modal_calendar_error_messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %}
      {% else %}
      <p>Expanded view for <strong>{{ widget_name }}</strong>.</p>
      {% if cached_payload_preview %}
      <p class="modal-meta">A specialized expanded view is not implemented for this widget yet.</p>
      {% endif %}
      {% endif %}

      {% if cache_key %}
      <p class="modal-meta">Cache key: <code>{{ cache_key }}</code></p>
      {% endif %}
      {% if cached_payload_preview %}
      <details class="modal-raw-details">
        <summary>Raw payload</summary>
        <pre class="modal-json">{{ cached_payload_preview }}</pre>
      </details>
      {% else %}
      <p class="empty-state">No cached payload available yet for this widget.</p>
      {% endif %}
    </div>
    <footer class="modal-footer">Updated {{ updated_at }}</footer>
  </article>
</div>
